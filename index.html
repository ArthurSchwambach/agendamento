<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container {
      width: 100%;
      max-width: 400px;
      padding: 1.5rem;
      background-color: #2d2d2d;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
      color: #f0f0f0;
    }
    button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: #3a5a78;
      color: white;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    button:hover { 
      background-color: #4a6b8a; 
    }
    button.disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    button.horario-disponivel {
      background-color: #2e7d32; /* Verde mais forte */
    }
    button.horario-disponivel:hover {
      background-color: #1b5e20; /* Verde mais escuro no hover */
    }
    button.horario-reservado {
      background-color: #c62828; /* Vermelho escuro */
      color: #ffffff; /* Texto branco */
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 6px;
      border: 1px solid #444;
      font-size: 1rem;
      background-color: #333;
      color: #e0e0e0;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background-color: #333;
      padding: 1.25rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }
    .hidden { 
      display: none; 
    }
    #admin-button {
      position: absolute;
      bottom: 0.75rem;
      right: 0.75rem;
      width: 20px;
      height: 20px;
      background: #3a5a78;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      cursor: pointer;
    }
    section {
      padding: 0.5rem;
    }
    .horario-btn {
      margin: 0.25rem;
      width: calc(50% - 0.5rem);
      display: inline-block;
    }
    .reserva-item {
      background-color: #3a3a3a;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      cursor: pointer;
    }
    .calendar {
      margin-bottom: 1rem;
    }
    .horarios-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85); /* Fundo mais escuro */
      z-index: 99;
    }
    .info-reserva {
      margin-bottom: 1rem;
    }
    .info-reserva p {
      margin: 0.5rem 0;
    }
    .mensagem-flutuante {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #2e7d32;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: fadeInOut 3s ease-in-out;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; top: 0; }
      10% { opacity: 1; top: 20px; }
      90% { opacity: 1; top: 20px; }
      100% { opacity: 0; top: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Página Inicial -->
    <section id="pagina-inicial">
      <h1>Agendamento</h1>
      <button onclick="mostrarPagina('horarios')">Ver Horários</button>
      <button onclick="mostrarPagina('minhas-reservas')">Minhas Reservas</button>
      <div id="admin-button" onclick="mostrarLoginAdmin()">A</div>
    </section>

    <!-- Modal Login Admin -->
    <div id="admin-login" class="modal hidden">
      <h2>Login Administrador</h2>
      <input type="text" id="admin-user" placeholder="Usuário" value="admin">
      <input type="password" id="admin-pass" placeholder="Senha" value="admin">
      <button onclick="loginAdmin()">Entrar</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>

    <!-- Modal Reserva -->
    <div id="reserva-modal" class="modal hidden">
      <h2 id="reserva-modal-titulo">Reservar Horário</h2>
      <input type="text" id="cliente-nome" placeholder="Seu Nome" required>
      <input type="tel" id="cliente-telefone" placeholder="Seu Telefone" required>
      <select id="forma-pagamento" required>
        <option value="">Forma de Pagamento</option>
        <option value="PIX">PIX</option>
        <option value="Cartão">Cartão</option>
        <option value="Dinheiro">Dinheiro</option>
      </select>
      <button onclick="confirmarReserva()">Confirmar Reserva</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>

    <!-- Modal Info Reserva (Admin) -->
    <div id="info-reserva-modal" class="modal hidden">
      <h2>Informações da Reserva</h2>
      <div class="info-reserva">
        <p><strong>Data:</strong> <span id="info-data"></span></p>
        <p><strong>Horário:</strong> <span id="info-horario"></span></p>
        <p><strong>Nome:</strong> <span id="info-nome"></span></p>
        <p><strong>Telefone:</strong> <span id="info-telefone"></span></p>
        <p><strong>Pagamento:</strong> <span id="info-pagamento"></span></p>
      </div>
      <button onclick="cancelarReservaAdmin()" style="background-color: #d32f2f;">Excluir Reserva</button>
      <button onclick="fecharModal()">Fechar</button>
    </div>

    <!-- Modal Confirmação -->
    <div id="confirmacao-modal" class="modal hidden">
      <h2 id="confirmacao-titulo">Confirmar Ação</h2>
      <p id="confirmacao-mensagem"></p>
      <button onclick="confirmarAcao()" id="confirmacao-botao">Confirmar</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>

    <!-- Modal Mensagem -->
    <div id="mensagem-modal" class="modal hidden">
      <h2 id="mensagem-titulo">Mensagem</h2>
      <p id="mensagem-conteudo"></p>
      <button onclick="fecharModal()">Fechar</button>
    </div>

    <!-- Página: Ver Horários -->
    <section id="pagina-horarios" class="hidden">
      <h1>Horários Disponíveis</h1>
      <div class="calendar">
        <input type="text" id="calendario-input" placeholder="Selecione uma data">
      </div>
      <div id="horarios" class="horarios-container"></div>
      <button onclick="mostrarPagina('inicial')">Voltar</button>
    </section>

    <!-- Página: Minhas Reservas -->
    <section id="pagina-minhas-reservas" class="hidden">
      <h1>Minhas Reservas</h1>
      <div id="lista-reservas"></div>
      <button onclick="mostrarPagina('inicial')">Voltar</button>
    </section>

    <!-- Página: Admin Visualização -->
    <section id="pagina-admin" class="hidden">
      <h1>Horários do Dia</h1>
      <div class="calendar">
        <input type="text" id="calendario-admin-input" placeholder="Selecione uma data">
      </div>
      <div id="horarios-admin" class="horarios-container"></div>
      <button onclick="mostrarPagina('admin-criar')">Criar Horários</button>
      <button onclick="mostrarPagina('inicial')">Sair</button>
    </section>

    <!-- Página: Admin Criar Horários -->
    <section id="pagina-admin-criar" class="hidden">
      <h1>Criar Horários</h1>
      <div class="calendar">
        <input type="text" id="data-criacao-input" placeholder="Selecione uma data">
      </div>
      <div id="botoes-horarios" class="horarios-container"></div>
      <div style="display: flex; gap: 0.5rem;">
        <button onclick="marcarTodosHorarios()" style="flex: 1;">Marcar Tudo</button>
        <button onclick="preencherSemana()" style="flex: 1;">Preencher Semana</button>
      </div>
      <button onclick="salvarHorarios()" class="horario-disponivel">Salvar Horários</button>
      <button onclick="limparDia()" style="background-color: #d32f2f;">Limpar Todos Horários</button>
      <button onclick="mostrarPagina('admin')">Voltar</button>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBnl2p5jBap04iXUdyL2Uko9dxGUy5Tpko",
      authDomain: "agendamento-ae896.firebaseapp.com",
      projectId: "agendamento-ae896",
      storageBucket: "agendamento-ae896.appspot.com",
      messagingSenderId: "755996309787",
      appId: "1:755996309787:web:3b4be84dd07512c829fbbe",
      measurementId: "G-M0X48MH74Z"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variáveis globais
    let selectedDate = null;
    let selectedTime = null;
    let currentUser = null;
    let reservaAtual = null;
    let modoAdmin = false;
    let calendarioInput, calendarioAdminInput, dataCriacaoInput;
    let acaoConfirmacao = null;

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      // Configura o localStorage para "lembrar" o usuário
      currentUser = localStorage.getItem('agendamento_user') || generateUserId();
      localStorage.setItem('agendamento_user', currentUser);
      
      // Configuração comum para os calendários
      const commonConfig = {
        locale: "pt",
        minDate: "today",
        dateFormat: "d/m/Y",
        defaultDate: new Date(), // Mostra o dia atual por padrão
        onChange: function(selectedDates, dateStr, instance) {
          selectedDate = formatFirestoreDate(selectedDates[0]);
          resetarPagina();
        }
      };

      // Inicializa os calendários
      calendarioInput = flatpickr("#calendario-input", {
        ...commonConfig,
        onChange: function(selectedDates, dateStr, instance) {
          selectedDate = formatFirestoreDate(selectedDates[0]);
          carregarHorariosDisponiveis();
        }
      });

      calendarioAdminInput = flatpickr("#calendario-admin-input", {
        ...commonConfig,
        onChange: function(selectedDates, dateStr, instance) {
          selectedDate = formatFirestoreDate(selectedDates[0]);
          carregarHorariosAdmin();
        }
      });

      dataCriacaoInput = flatpickr("#data-criacao-input", {
        ...commonConfig,
        onChange: function(selectedDates, dateStr, instance) {
          selectedDate = formatFirestoreDate(selectedDates[0]);
          criarBotoesHorarios();
        }
      });

      // Carrega automaticamente o dia atual
      selectedDate = formatFirestoreDate(new Date());
      
      // Se estiver na página de horários, carrega automaticamente
      if (window.location.hash === '#horarios') {
        mostrarPagina('horarios');
        carregarHorariosDisponiveis();
      }
    });

    function mostrarMensagem(titulo, mensagem) {
      document.getElementById('mensagem-titulo').textContent = titulo;
      document.getElementById('mensagem-conteudo').textContent = mensagem;
      document.getElementById('mensagem-modal').classList.remove('hidden');
      document.body.insertAdjacentHTML('beforeend', '<div class="overlay"></div>');
    }

    function mostrarConfirmacao(titulo, mensagem, acao) {
      document.getElementById('confirmacao-titulo').textContent = titulo;
      document.getElementById('confirmacao-mensagem').textContent = mensagem;
      document.getElementById('confirmacao-botao').textContent = titulo;
      acaoConfirmacao = acao;
      document.getElementById('confirmacao-modal').classList.remove('hidden');
      document.body.insertAdjacentHTML('beforeend', '<div class="overlay"></div>');
    }

    function confirmarAcao() {
      if (acaoConfirmacao) {
        acaoConfirmacao();
      }
      fecharModal();
    }

    function mostrarMensagemFlutuante(mensagem) {
      const div = document.createElement('div');
      div.className = 'mensagem-flutuante';
      div.textContent = mensagem;
      document.body.appendChild(div);
      
      setTimeout(() => {
        div.remove();
      }, 3000);
    }

    function resetarPagina() {
      const paginaAtual = document.querySelector('section:not(.hidden)').id;
      
      if (paginaAtual === 'pagina-horarios') {
        carregarHorariosDisponiveis();
      } else if (paginaAtual === 'pagina-admin') {
        carregarHorariosAdmin();
      } else if (paginaAtual === 'pagina-admin-criar') {
        criarBotoesHorarios();
      }
    }

    // Funções de navegação
    function mostrarPagina(pagina) {
      document.getElementById('pagina-inicial').classList.add('hidden');
      document.getElementById('pagina-horarios').classList.add('hidden');
      document.getElementById('pagina-minhas-reservas').classList.add('hidden');
      document.getElementById('pagina-admin').classList.add('hidden');
      document.getElementById('pagina-admin-criar').classList.add('hidden');

      // Reseta os calendários para a data atual
      const hoje = new Date();
      selectedDate = formatFirestoreDate(hoje);
      
      if (pagina === 'inicial') {
        document.getElementById('pagina-inicial').classList.remove('hidden');
      } else if (pagina === 'horarios') {
        calendarioInput.setDate(hoje);
        document.getElementById('pagina-horarios').classList.remove('hidden');
        carregarHorariosDisponiveis();
      } else if (pagina === 'minhas-reservas') {
        document.getElementById('pagina-minhas-reservas').classList.remove('hidden');
        carregarMinhasReservas();
      } else if (pagina === 'admin') {
        modoAdmin = true;
        calendarioAdminInput.setDate(hoje);
        document.getElementById('pagina-admin').classList.remove('hidden');
        carregarHorariosAdmin();
      } else if (pagina === 'admin-criar') {
        dataCriacaoInput.setDate(hoje);
        document.getElementById('pagina-admin-criar').classList.remove('hidden');
        criarBotoesHorarios();
      }
    }

    function mostrarLoginAdmin() {
      document.getElementById('admin-login').classList.remove('hidden');
      document.body.insertAdjacentHTML('beforeend', '<div class="overlay"></div>');
    }

    function loginAdmin() {
      const user = document.getElementById('admin-user').value;
      const pass = document.getElementById('admin-pass').value;

      // Credenciais válidas (pode adicionar mais se necessário)
      const credenciaisValidas = [
        { usuario: 'admin', senha: 'admin' },
        { usuario: 'adm', senha: 'adm' }
      ];

      const credencialValida = credenciaisValidas.some(
        cred => cred.usuario === user && cred.senha === pass
      );

      if (credencialValida) {
        fecharModal();
        mostrarPagina('admin');
      } else {
        mostrarMensagem('Login inválido', 'Usuário ou senha incorretos.');
      }
    }

    function fecharModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.add('hidden');
      });
      document.querySelectorAll('.overlay').forEach(overlay => {
        overlay.remove();
      });
    }

    // Funções de gerenciamento de usuário
    function generateUserId() {
      return 'user_' + Math.random().toString(36).substr(2, 9);
    }

    // Funções de formatação de data
    function formatFirestoreDate(date) {
      const d = new Date(date);
      return d.toISOString().split('T')[0]; // Formato YYYY-MM-DD
    }

    function formatDisplayDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }

    function formatTimeDisplay(timeStr) {
      return timeStr.replace(':00', 'h');
    }

    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // Funções para horários disponíveis
    async function carregarHorariosDisponiveis() {
      if (!selectedDate) return;
      
      const horariosDiv = document.getElementById('horarios');
      horariosDiv.innerHTML = '<p>Carregando...</p>';
      
      try {
        const snapshot = await db.collection('horarios').doc(selectedDate).get();
        
        if (!snapshot.exists) {
          horariosDiv.innerHTML = '<p>Nenhum horário disponível para esta data.</p>';
          return;
        }
        
        const horariosData = snapshot.data();
        horariosDiv.innerHTML = '';
        
        // Ordem personalizada dos horários (agora agrupados corretamente)
        const horariosManha = ['08:00', '09:00', '10:00', '11:00'];
        const horariosTarde = ['13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        const horariosOrdenados = [...horariosManha, ...horariosTarde];
        
        horariosOrdenados.forEach(time => {
          if (horariosData[time] !== undefined) {
            const btn = document.createElement('button');
            btn.className = 'horario-btn';
            
            if (horariosData[time].reservado) {
              btn.textContent = `${formatTimeDisplay(time)} (Reservado)`;
              btn.classList.add('horario-reservado');
              btn.onclick = () => mostrarMensagem('Horário Reservado', 'Este horário já está reservado.');
            } else {
              btn.textContent = formatTimeDisplay(time);
              btn.classList.add('horario-disponivel');
              btn.onclick = () => abrirModalReserva(time);
            }
            
            horariosDiv.appendChild(btn);
          }
        });
      } catch (error) {
        console.error("Erro ao carregar horários:", error);
        horariosDiv.innerHTML = '<p>Erro ao carregar horários.</p>';
      }
    }

    function abrirModalReserva(time) {
      selectedTime = time;
      document.getElementById('reserva-modal').classList.remove('hidden');
      document.body.insertAdjacentHTML('beforeend', '<div class="overlay"></div>');
    }

    async function confirmarReserva() {
      const nome = document.getElementById('cliente-nome').value;
      const telefone = document.getElementById('cliente-telefone').value;
      const pagamento = document.getElementById('forma-pagamento').value;
      
      if (!nome || !telefone || !pagamento) {
        mostrarMensagem('Campos obrigatórios', 'Por favor, preencha todos os campos.');
        return;
      }
      
      try {
        // Primeiro verifica se o horário ainda está disponível
        const docRef = await db.collection('horarios').doc(selectedDate).get();
        if (!docRef.exists || docRef.data()[selectedTime].reservado) {
          mostrarMensagem('Horário ocupado', 'Este horário já foi reservado por outra pessoa.');
          carregarHorariosDisponiveis();
          fecharModal();
          return;
        }
        
        // Atualiza o horário como reservado
        await db.collection('horarios').doc(selectedDate).update({
          [selectedTime]: {
            reservado: true,
            clienteId: currentUser,
            nome: nome,
            telefone: telefone,
            pagamento: pagamento,
            dataReserva: new Date().toISOString()
          }
        });
        
        // Envia mensagem para o WhatsApp
        const mensagemWhatsApp = `Nova reserva:\n\nData: ${formatDisplayDate(selectedDate)}\nHorário: ${formatTimeDisplay(selectedTime)}\nCliente: ${nome}\nTelefone: ${telefone}\nPagamento: ${pagamento}`;
        const urlWhatsApp = `https://wa.me/5527997563197?text=${encodeURIComponent(mensagemWhatsApp)}`;
        
        // Abre o WhatsApp em uma nova aba
        window.open(urlWhatsApp, '_blank');
        
        fecharModal();
        mostrarMensagemFlutuante('Reserva confirmada com sucesso!');
        carregarHorariosDisponiveis();
      } catch (error) {
        console.error("Erro ao confirmar reserva:", error);
        mostrarMensagem('Erro', 'Erro ao confirmar reserva. Tente novamente.');
      }
    }

    // Funções para minhas reservas
    async function carregarMinhasReservas() {
      const listaReservas = document.getElementById('lista-reservas');
      listaReservas.innerHTML = '<p>Carregando suas reservas...</p>';
      
      try {
        // Primeiro obtemos todas as datas que têm horários
        const snapshotDatas = await db.collection('horarios').get();
        
        if (snapshotDatas.empty) {
          listaReservas.innerHTML = '<p>Você não tem reservas.</p>';
          return;
        }
        
        let reservasEncontradas = false;
        listaReservas.innerHTML = '';
        
        // Para cada documento (data) no Firestore
        for (const doc of snapshotDatas.docs) {
          const data = doc.data();
          
          // Verifica cada horário nesta data
          for (const time in data) {
            if (data[time].reservado && data[time].clienteId === currentUser) {
              reservasEncontradas = true;
              const reservaDiv = document.createElement('div');
              reservaDiv.className = 'reserva-item';
              reservaDiv.innerHTML = `
                <p><strong>Data:</strong> ${formatDisplayDate(doc.id)}</p>
                <p><strong>Horário:</strong> ${formatTimeDisplay(time)}</p>
                <p><strong>Pagamento:</strong> ${data[time].pagamento}</p>
              `;
              reservaDiv.onclick = () => {
                mostrarConfirmacao(
                  'Cancelar Reserva',
                  `Deseja cancelar a reserva para ${formatDisplayDate(doc.id)} às ${formatTimeDisplay(time)}?`,
                  () => cancelarReserva(doc.id, time)
                );
              };
              listaReservas.appendChild(reservaDiv);
            }
          }
        }
        
        if (!reservasEncontradas) {
          listaReservas.innerHTML = '<p>Você não tem reservas.</p>';
        }
      } catch (error) {
        console.error("Erro ao carregar reservas:", error);
        listaReservas.innerHTML = '<p>Erro ao carregar suas reservas.</p>';
      }
    }

    async function cancelarReserva(date, time) {
      try {
        // Primeiro verifica se a reserva ainda existe e pertence ao usuário
        const docRef = await db.collection('horarios').doc(date).get();
        if (!docRef.exists || !docRef.data()[time] || !docRef.data()[time].reservado || docRef.data()[time].clienteId !== currentUser) {
          mostrarMensagem('Reserva não encontrada', 'Esta reserva não existe ou já foi cancelada.');
          carregarMinhasReservas();
          return;
        }
        
        // Cancela a reserva
        await db.collection('horarios').doc(date).update({
          [time]: {
            reservado: false,
            clienteId: null,
            nome: null,
            telefone: null,
            pagamento: null
          }
        });
        
        mostrarMensagemFlutuante('Reserva cancelada com sucesso!');
        carregarMinhasReservas();
      } catch (error) {
        console.error("Erro ao cancelar reserva:", error);
        mostrarMensagem('Erro', 'Erro ao cancelar reserva. Tente novamente.');
      }
    }

    // Funções para admin
    async function carregarHorariosAdmin() {
      if (!selectedDate) return;
      
      const horariosDiv = document.getElementById('horarios-admin');
      horariosDiv.innerHTML = '<p>Carregando...</p>';
      
      try {
        const snapshot = await db.collection('horarios').doc(selectedDate).get();
        
        if (!snapshot.exists) {
          horariosDiv.innerHTML = '<p>Nenhum horário cadastrado para esta data.</p>';
          return;
        }
        
        const horariosData = snapshot.data();
        horariosDiv.innerHTML = '';
        
        // Ordem personalizada dos horários (agora agrupados corretamente)
        const horariosManha = ['08:00', '09:00', '10:00', '11:00'];
        const horariosTarde = ['13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        const horariosOrdenados = [...horariosManha, ...horariosTarde];
        
        horariosOrdenados.forEach(time => {
          if (horariosData[time] !== undefined) {
            const btn = document.createElement('button');
            btn.className = 'horario-btn';
            
            if (horariosData[time].reservado) {
              btn.textContent = `${formatTimeDisplay(time)} (Reservado)`;
              btn.classList.add('horario-reservado');
              btn.onclick = () => mostrarInfoReservaAdmin(horariosData[time], time);
            } else {
              btn.textContent = `${formatTimeDisplay(time)} (Disponível)`;
              btn.classList.add('horario-disponivel');
              btn.onclick = () => {
                selectedTime = time;
                mostrarConfirmacao(
                  'Cancelar Horário',
                  `Deseja remover o horário ${formatTimeDisplay(time)}?`,
                  () => cancelarReservaAdmin()
                );
              };
            }
            
            horariosDiv.appendChild(btn);
          }
        });
      } catch (error) {
        console.error("Erro ao carregar horários:", error);
        horariosDiv.innerHTML = '<p>Erro ao carregar horários.</p>';
      }
    }

    function mostrarInfoReservaAdmin(reserva, time) {
      document.getElementById('info-data').textContent = formatDisplayDate(selectedDate);
      document.getElementById('info-horario').textContent = formatTimeDisplay(time);
      document.getElementById('info-nome').textContent = reserva.nome;
      document.getElementById('info-telefone').textContent = reserva.telefone;
      document.getElementById('info-pagamento').textContent = reserva.pagamento;
      reservaAtual = reserva;
      selectedTime = time;
      document.getElementById('info-reserva-modal').classList.remove('hidden');
      document.body.insertAdjacentHTML('beforeend', '<div class="overlay"></div>');
    }

    async function cancelarReservaAdmin() {
      try {
        await db.collection('horarios').doc(selectedDate).update({
          [selectedTime]: {
            reservado: false,
            clienteId: null,
            nome: null,
            telefone: null,
            pagamento: null
          }
        });
        
        if (document.getElementById('info-reserva-modal').classList.contains('hidden')) {
          mostrarMensagemFlutuante('Horário liberado com sucesso!');
        } else {
          fecharModal();
        }
        carregarHorariosAdmin();
      } catch (error) {
        console.error("Erro ao cancelar reserva:", error);
        mostrarMensagem('Erro', 'Erro ao liberar horário. Tente novamente.');
      }
    }

    // Funções para criar horários
    function criarBotoesHorarios() {
      if (!selectedDate) return;
      
      const botoesDiv = document.getElementById('botoes-horarios');
      botoesDiv.innerHTML = '';
      
      // Horários na ordem específica (agrupados corretamente)
      const horariosManha = ['08:00', '09:00', '10:00', '11:00'];
      const horariosTarde = ['13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
      const horariosOrdenados = [...horariosManha, ...horariosTarde];
      
      horariosOrdenados.forEach(time => {
        const btn = document.createElement('button');
        btn.className = 'horario-btn';
        btn.textContent = formatTimeDisplay(time);
        btn.dataset.time = time;
        btn.dataset.selected = 'false';
        btn.classList.add('disabled');
        btn.onclick = () => toggleHorarioSelecionado(btn);
        botoesDiv.appendChild(btn);
      });
    }

    function toggleHorarioSelecionado(btn) {
      btn.classList.toggle('disabled');
      btn.dataset.selected = btn.classList.contains('disabled') ? 'false' : 'true';
      
      // Adiciona/remove a classe de horário disponível
      if (btn.classList.contains('disabled')) {
        btn.classList.remove('horario-disponivel');
      } else {
        btn.classList.add('horario-disponivel');
      }
    }

    function marcarTodosHorarios() {
      document.querySelectorAll('#botoes-horarios .horario-btn').forEach(btn => {
        btn.classList.remove('disabled');
        btn.classList.add('horario-disponivel');
        btn.dataset.selected = 'true';
      });
    }

    async function preencherSemana() {
      if (!selectedDate) return;
      
      mostrarConfirmacao(
        'Preencher Semana',
        'Deseja criar horários para os próximos 6 dias a partir da data selecionada?',
        async () => {
          try {
            const dataAtual = new Date(selectedDate);
            const horariosSelecionados = {};
            
            // Pega os horários selecionados na data atual
            document.querySelectorAll('#botoes-horarios .horario-btn[data-selected="true"]').forEach(btn => {
              horariosSelecionados[btn.dataset.time] = {
                reservado: false,
                clienteId: null,
                nome: null,
                telefone: null,
                pagamento: null
              };
            });
            
            if (Object.keys(horariosSelecionados).length === 0) {
              mostrarMensagem('Aviso', 'Nenhum horário selecionado para a data atual.');
              return;
            }
            
            // Preenche os próximos 6 dias
            for (let i = 1; i <= 6; i++) {
              const novaData = addDays(dataAtual, i);
              const dataStr = formatFirestoreDate(novaData);
              
              await db.collection('horarios').doc(dataStr).set(horariosSelecionados, { merge: true });
            }
            
            mostrarMensagemFlutuante('Semana preenchida com sucesso!');
          } catch (error) {
            console.error("Erro ao preencher semana:", error);
            mostrarMensagem('Erro', 'Erro ao preencher semana. Tente novamente.');
          }
        }
      );
    }

    async function limparDia() {
      if (!selectedDate) return;
      
      mostrarConfirmacao(
        'Limpar Horários',
        'Deseja remover TODOS os horários para esta data?',
        async () => {
          try {
            await db.collection('horarios').doc(selectedDate).delete();
            mostrarMensagemFlutuante('Horários removidos com sucesso!');
            criarBotoesHorarios();
          } catch (error) {
            console.error("Erro ao limpar horários:", error);
            mostrarMensagem('Erro', 'Erro ao limpar horários. Tente novamente.');
          }
        }
      );
    }

    async function salvarHorarios() {
      if (!selectedDate) {
        mostrarMensagem('Aviso', 'Selecione uma data primeiro.');
        return;
      }
      
      const horariosSelecionados = {};
      document.querySelectorAll('#botoes-horarios .horario-btn[data-selected="true"]').forEach(btn => {
        horariosSelecionados[btn.dataset.time] = {
          reservado: false,
          clienteId: null,
          nome: null,
          telefone: null,
          pagamento: null
        };
      });
      
      if (Object.keys(horariosSelecionados).length === 0) {
        mostrarMensagem('Aviso', 'Selecione pelo menos um horário.');
        return;
      }
      
      try {
        await db.collection('horarios').doc(selectedDate).set(horariosSelecionados, { merge: true });
        mostrarMensagemFlutuante('Horários salvos com sucesso!');
        // Não redireciona, fica na mesma página
        criarBotoesHorarios();
      } catch (error) {
        console.error("Erro ao salvar horários:", error);
        mostrarMensagem('Erro', 'Erro ao salvar horários. Tente novamente.');
      }
    }
  </script>
</body>
</html>